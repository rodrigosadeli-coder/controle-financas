<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Fam√≠lia Pedrosa de Lima</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ... (mantenha todo o estilo original, √© extenso mas n√£o houve altera√ß√£o) ... */
        /* Para n√£o repetir os 1500+ linhas de CSS, mas voc√™ deve manter o conte√∫do original */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* ... todo o CSS original deve permanecer ... */
    </style>
<base target="_blank">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Conectando ao Supabase...</div>
    </div>

    <!-- Tela de Login -->
    <div class="login-screen" id="loginScreen">
        <!-- ... (todo o conte√∫do original permanece) ... -->
        <div class="login-container">
            <!-- ... -->
            <form id="loginForm">
                <!-- ... -->
            </form>
            <p style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                N√£o tem conta? <a href="#" onclick="showRegister()" style="color: var(--gold-primary);">Cadastre-se</a>
            </p>
            <!-- ... -->
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div class="app-container" id="appContainer">
        <!-- ... todo o HTML original (header, nav, main, modais) ... -->
    </div>

    <!-- ... demais modais ... -->

    <!-- Modal de Cadastro -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìù Cadastro</h3>
                <button class="close-btn" onclick="closeRegisterModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-row">
                        <label class="form-label-modal">Nome Completo</label>
                        <input type="text" class="form-input-modal" id="regName" placeholder="Seu nome completo" required>
                    </div>
                    <div class="form-row">
                        <label class="form-label-modal">Email</label>
                        <input type="email" class="form-input-modal" id="regEmail" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-row">
                        <label class="form-label-modal">Senha</label>
                        <input type="password" class="form-input-modal" id="regPassword" placeholder="M√≠nimo 6 caracteres" required>
                    </div>
                    <div class="form-row">
                        <label class="form-label-modal">Confirmar Senha</label>
                        <input type="password" class="form-input-modal" id="regConfirmPassword" placeholder="Confirme sua senha" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeRegisterModal()">Cancelar</button>
                <button type="button" class="btn btn-save" onclick="registerUser()">Cadastrar</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle">Sucesso</div>
        <div class="notification-text" id="notificationText">Opera√ß√£o realizada com sucesso!</div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DO SUPABASE - CREDENCIAIS ATUALIZADAS
        // ==========================================
        
        const SUPABASE_URL = 'https://esknlhztamypntxxvxpe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVza25saHp0YW15cG50eHh2eHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NDEyOTAsImV4cCI6MjA4NjUxNzI5MH0.sT0F2QX8kpF06gma-fkvc2EQnFpuSZntdofWgLjMScM';
        
        let supabaseClient = null;
        let currentUser = null;
        let isDevMode = false;
        let isOnline = false;
        
        let localData = {
            transactions: [],
            notebooks: [],
            notes: [],
            appointments: [],
            paymentHistory: []
        };

        // ==========================================
        // MOTOR DE MONITORAMENTO DE QUALIDADE (V3.0)
        // ==========================================
        async function monitorar(nomeFuncao, acao) {
            // ... (mantenha o c√≥digo original) ...
        }

        // ==========================================
        // FUN√á√ÉO DE GERA√á√ÉO DE RELAT√ìRIO PDF
        // ==========================================
        async function gerarRelatorioPDF() {
            // ... (original) ...
        }

        // ... (todo o restante do c√≥digo original permanece, exceto a fun√ß√£o registerUser que foi corrigida) ...

        // ==========================================
        // FUN√á√ÉO REGISTERUSER CORRIGIDA
        // ==========================================
        async function registerUser() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (password !== confirmPassword) {
                showNotification('As senhas n√£o coincidem!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('A senha deve ter no m√≠nimo 6 caracteres!', 'error');
                return;
            }

            try {
                if (!isOnline) {
                    throw new Error('Sem conex√£o com o servidor');
                }

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (error) throw error;

                // ‚úÖ CORRE√á√ÉO: Verificar se data.user existe antes de acessar
                if (data && data.user) {
                    // ‚úÖ Tratamento de erro espec√≠fico para inser√ß√£o de perfil
                    try {
                        const { error: profileError } = await supabaseClient
                            .from('profiles')
                            .insert([
                                { id: data.user.id, full_name: name, email: email }
                            ]);
                        
                        if (profileError) {
                            console.log('Perfil pode j√° existir via trigger ou erro:', profileError.message);
                            // N√£o interrompe o fluxo - o usu√°rio foi criado com sucesso
                        }
                    } catch (profileError) {
                        // Log silencioso - n√£o impede o cadastro de ser considerado sucesso
                        console.log('Inser√ß√£o de perfil ignorada:', profileError.message);
                    }
                }

                showNotification('Cadastro realizado! Verifique seu email.');
                closeRegisterModal();
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showNotification('Erro ao cadastrar: ' + error.message, 'error');
            }
        }

        // ... (todo o restante do c√≥digo original: initSupabase, logout, etc.) ...

        // Inicializar ao carregar
        window.addEventListener('DOMContentLoaded', initSupabase);
    </script>
</body>
</html>